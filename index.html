<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>星尘 · 你来过，这里就有光</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body onload="init()">

  <div id="stars"></div>
  
  <!-- 流星容器 -->
  <div id="meteors"></div>

<script>
// IP信息获取
async function getIPInfo() {
  try {
    const res = await fetch('https://ipapi.co/json/');
    const data = await res.json();
    return {
      ip: data.ip,
      city: data.city || '未知',
      country: data.country_name || ''
    };
  } catch {
    return { ip: 'unknown', city: '未知', country: '' };
  }
}

// 哈希函数（IP转数值）
function hashCode(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return Math.abs(hash);
}

// 生成星星属性（完全由哈希决定）
function generateStarProperties(ipHash) {
  const colors = ['white', 'gold', 'blue', 'pink', 'purple'];
  const symbols = ['✦', '✧', '✶', '✹', '❋'];
  const sizes = [0.45, 0.55, 0.65, 0.75, 0.85];
  const blinkSpeeds = ['slow', 'normal', 'fast'];
  const blinkDurations = [6000, 4000, 2500];
  const glowLevels = ['subtle', 'medium', 'strong'];
  
  const colorIndex = ipHash % colors.length;
  const symbolIndex = (ipHash >> 2) % symbols.length;
  const sizeIndex = (ipHash >> 4) % sizes.length;
  const blinkIndex = (ipHash >> 6) % blinkSpeeds.length;
  const glowIndex = (ipHash >> 8) % glowLevels.length;
  
  // 位置分布（防重叠）
  const posX = (ipHash % 94) + 3;
  const posY = (ipHash % 90) + 5;
  
  return {
    color: colors[colorIndex],
    symbol: symbols[symbolIndex],
    size: sizes[sizeIndex],
    blinkSpeed: blinkSpeeds[blinkIndex],
    blinkDuration: blinkDurations[blinkIndex],
    glow: glowLevels[glowIndex],
    x: posX,
    y: posY
  };
}

// 根据时间段生成标签
function getTimeLabel() {
  const hour = new Date().getHours();
  if (hour >= 0 && hour < 5) return '夜行人';
  if (hour >= 5 && hour < 8) return '黎明访客';
  if (hour >= 8 && hour < 12) return '晨光过客';
  if (hour >= 12 && hour < 14) return '午间旅者';
  if (hour >= 14 && hour < 18) return '午后漫游者';
  if (hour >= 18 && hour < 21) return '夕照归人';
  return '星夜来客';
}

// 颜色配置
const colorMap = {
  white: { color: '#fff9e6', glow: 'rgba(255, 249, 230, ' },
  gold: { color: '#ffd700', glow: 'rgba(255, 215, 0, ' },
  blue: { color: '#87ceeb', glow: 'rgba(135, 206, 235, ' },
  pink: { color: '#ffb6c1', glow: 'rgba(255, 182, 193, ' },
  purple: { color: '#da70d6', glow: 'rgba(218, 112, 214, ' }
};

// 全局状态
let myStarData = null;
let starsData = [];

// 初始化
async function init() {
  // 获取IP信息
  const ipInfo = await getIPInfo();
  const ipHash = hashCode(ipInfo.ip);
  
  // 生成自己的星星属性
  const props = generateStarProperties(ipHash);
  const timeLabel = getTimeLabel();
  
  // 保存到本地（用于回访识别）
  const localKey = 'mystar_ip_hash';
  const isReturning = localStorage.getItem(localKey) === ipHash.toString();
  localStorage.setItem(localKey, ipHash.toString());
  
  myStarData = {
    ip_hash: ipHash.toString().slice(-8),
    city: ipInfo.city,
    country: ipInfo.country,
    color: props.color,
    symbol: props.symbol,
    size: props.size,
    blinkSpeed: props.blinkSpeed,
    blinkDuration: props.blinkDuration,
    glow: props.glow,
    x: props.x,
    y: props.y,
    label: timeLabel,
    created_at: new Date().toISOString().replace(/[-:T]/g, '').slice(0, 14),
    is_returning: isReturning
  };
  
  // 创建星星并显示流星引导
  if (!isReturning) {
    createMyStar();
    setTimeout(() => {
      showMeteor(myStarData.x, myStarData.y);
      loadAllStars();
    }, 300);
  } else {
    createMyStar();
    setTimeout(() => {
      highlightMyStar();
      loadAllStars();
    }, 500);
  }
}

// 单颗流星动画（引导视线到我的星星）
function showMeteor(targetX, targetY) {
  const container = document.getElementById('meteors');
  const meteor = document.createElement('div');
  meteor.className = 'meteor';
  
  // 从左上角划过，目标是我的星星位置
  const startX = -20;
  const startY = -20;
  const deltaX = targetX - startX;
  const deltaY = targetY - startY;
  const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;
  const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
  const duration = Math.max(600, distance * 6);
  
  meteor.style.left = startX + '%';
  meteor.style.top = startY + '%';
  meteor.style.width = distance * 0.7 + '%';
  meteor.style.transform = `rotate(${angle}deg)`;
  meteor.style.animationDuration = duration + 'ms';
  
  container.appendChild(meteor);
  
  setTimeout(() => meteor.remove(), duration);
}

// 创建我的星星
function createMyStar() {
  addStar(myStarData, true);
}

// 高亮我的星星（回访）
function highlightMyStar() {
  addStar(myStarData, true, true);
}

// 加载所有星星
async function loadAllStars() {
  try {
    const res = await fetch('/api/stars');
    starsData = await res.json();
    
    starsData.forEach((star, index) => {
      if (star.ip_hash === myStarData.ip_hash) return;
      setTimeout(() => {
        addStar(star, false);
      }, Math.min(index * 30, 1000));
    });
  } catch(e) {
    console.error('加载星星失败:', e);
  }
}

// 添加星星到页面
function addStar(data, isMine = false, highlight = false) {
  const div = document.createElement('div');
  const colorConfig = colorMap[data.color] || colorMap.white;
  
  // 计算发光强度
  let glowOuter, opacity;
  if (data.glow === 'strong') {
    glowOuter = '0 0 8px ' + colorConfig.glow + '0.6), 0 0 16px ' + colorConfig.glow + '0.3)';
    opacity = 0.9;
  } else if (data.glow === 'subtle') {
    glowOuter = '0 0 4px ' + colorConfig.glow + '0.3), 0 0 8px ' + colorConfig.glow + '0.15)';
    opacity = 0.7;
  } else {
    glowOuter = '0 0 6px ' + colorConfig.glow + '0.4), 0 0 12px ' + colorConfig.glow + '0.2)';
    opacity = 0.8;
  }
  
  div.className = 'star' + (isMine ? ' mine' : '') + (highlight ? ' highlight' : '');
  div.style.left = data.x + '%';
  div.style.top = data.y + '%';
  div.style.fontSize = data.size + 'rem';
  div.style.color = colorConfig.color;
  div.style.setProperty('--star-color', colorConfig.color);
  div.style.setProperty('--glow-outer', glowOuter);
  div.style.opacity = 0;
  div.style.animationDuration = data.blinkDuration + 'ms';
  
  div.innerHTML = `<span class="star-symbol">${data.symbol}</span>`;
  
  div.addEventListener('click', (e) => {
    e.stopPropagation();
    showStarDetail(data, isMine);
  });
  
  document.getElementById('stars').appendChild(div);
  
  // 渐显
  requestAnimationFrame(() => {
    div.style.transition = 'opacity 0.8s ease-out';
    div.style.opacity = opacity;
  });
}

// 显示星星详情
function showStarDetail(data, isMine) {
  const div = document.createElement('div');
  div.className = 'detail-popup';
  div.innerHTML = `
    <div class="detail-content">
      <span class="detail-symbol" style="color: ${colorMap[data.color].color}">${data.symbol}</span>
      <div class="detail-info">
        <strong>${data.label}</strong>
        <span>${data.city} · ${formatTime(data.created_at)}</span>
        ${!isMine ? '<span class="detail-hint">从远方闪烁的星光</span>' : '<span class="detail-hint">这是你的星星</span>'}
      </div>
    </div>
  `;
  
  div.style.left = (data.x > 50 ? data.x - 15 : data.x + 3) + '%';
  div.style.top = (data.y > 50 ? data.y - 12 : data.y + 2) + '%';
  
  document.body.appendChild(div);
  
  setTimeout(() => {
    div.classList.add('show');
  }, 10);
  
  setTimeout(() => {
    document.addEventListener('click', function handler() {
      div.remove();
      document.removeEventListener('click', handler);
    });
  }, 100);
}

// 格式化时间
function formatTime(t) {
  if (!t || t.length < 12) return '未知时间';
  const month = t.slice(4, 6);
  const day = t.slice(6, 8);
  const hour = t.slice(8, 10);
  const min = t.slice(10, 12);
  return `${month}月${day}日 ${hour}:${min}`;
}
</script>
</body>
</html>