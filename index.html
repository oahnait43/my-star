<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ä½ æ¥è¿‡ï¼Œè¿™é‡Œå°±æœ‰å…‰</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body onload="initStars()">

  <div id="stars"></div>

  <!-- æ¬¢è¿é¢æ¿ -->
  <div id="welcome-modal" class="modal">
    <div class="modal-content welcome-content">
      <h2>âœ¨ æ¬¢è¿æ¥åˆ°æ˜Ÿç©º âœ¨</h2>
      <p>åœ¨è¿™ç‰‡æ˜Ÿç©ºç•™ä¸‹å±äºä½ çš„å…‰èŠ’</p>
      
      <div class="customize-section">
        <label>é€‰æ‹©ä½ çš„èº«ä»½</label>
        <div class="nickname-options">
          <div class="nickname-option selected" data-nickname="åŒ¿åæ—…äºº">åŒ¿åæ—…äºº</div>
          <div class="nickname-option" data-nickname="æ˜Ÿç©ºè¡Œè€…">æ˜Ÿç©ºè¡Œè€…</div>
          <div class="nickname-option" data-nickname="è¿½æ¢¦äºº">è¿½æ¢¦äºº</div>
          <div class="nickname-option" data-nickname="å¤œè¡Œè€…">å¤œè¡Œè€…</div>
          <div class="nickname-option" data-nickname="è‡ªç”±çµé­‚">è‡ªç”±çµé­‚</div>
          <div class="nickname-option" data-nickname="æ—¶å…‰æ—…è€…">æ—¶å…‰æ—…è€…</div>
        </div>
      </div>
      
      <div class="customize-section">
        <label>é€‰æ‹©æ˜Ÿæ˜Ÿé¢œè‰²</label>
        <div class="color-options">
          <div class="color-option selected" data-color="white" style="background: #fff9e6; box-shadow: 0 0 10px #fff9;"></div>
          <div class="color-option" data-color="gold" style="background: #ffd700; box-shadow: 0 0 10px #ffd700;"></div>
          <div class="color-option" data-color="blue" style="background: #87ceeb; box-shadow: 0 0 10px #87ceeb;"></div>
          <div class="color-option" data-color="pink" style="background: #ffb6c1; box-shadow: 0 0 10px #ffb6c1;"></div>
          <div class="color-option" data-color="purple" style="background: #da70d6; box-shadow: 0 0 10px #da70d6;"></div>
        </div>
      </div>
      
      <div class="customize-section">
        <label>é€‰æ‹©æ˜Ÿæ˜Ÿç¬¦å·</label>
        <div class="symbol-options">
          <div class="symbol-option selected" data-symbol="âœ¦">âœ¦</div>
          <div class="symbol-option" data-symbol="âœ§">âœ§</div>
          <div class="symbol-option" data-symbol="âœ¶">âœ¶</div>
          <div class="symbol-option" data-symbol="âœ¹">âœ¹</div>
          <div class="symbol-option" data-symbol="â‹">â‹</div>
        </div>
      </div>
      
      <button id="start-btn" class="btn-primary">ç‚¹äº®æˆ‘çš„æ˜Ÿæ˜Ÿ</button>
    </div>
  </div>

  <!-- ç•™è¨€å¼¹çª— -->
  <div id="message-modal" class="modal hidden">
    <div class="modal-content message-content">
      <button class="close-btn" onclick="closeMessageModal()">Ã—</button>
      <h3>ğŸŒŸ æ˜Ÿæ˜Ÿç•™è¨€</h3>
      <div id="star-info" class="star-info"></div>
      <div id="message-display" class="message-display"></div>
      <label style="display:block;margin:1rem 0 0.5rem;font-size:0.75rem;color:rgba(180,160,220,0.9);text-transform:uppercase;letter-spacing:0.08em;">é€‰æ‹©ä¸€å¥ç•™è¨€</label>
      <div class="message-options">
        <div class="message-option" data-message="æˆ‘æ¥è¿‡è¿™ç‰‡æ˜Ÿç©º">æˆ‘æ¥è¿‡è¿™ç‰‡æ˜Ÿç©º</div>
        <div class="message-option" data-message="æ„¿æ˜Ÿå…‰æŒ‡å¼•ä½ ">æ„¿æ˜Ÿå…‰æŒ‡å¼•ä½ </div>
        <div class="message-option" data-message="æ­¤åˆ»ï¼Œæˆ‘ä»¬åŒåœ¨">æ­¤åˆ»ï¼Œæˆ‘ä»¬åŒåœ¨</div>
        <div class="message-option" data-message="ç•™ä¸‹ä¸€ç‚¹å…‰">ç•™ä¸‹ä¸€ç‚¹å…‰</div>
        <div class="message-option" data-message="ä½ å¥½ï¼Œé™Œç”Ÿäºº">ä½ å¥½ï¼Œé™Œç”Ÿäºº</div>
        <div class="message-option" data-message="æ™šå®‰ï¼Œå¥½æ¢¦">æ™šå®‰ï¼Œå¥½æ¢¦</div>
        <div class="message-option" data-message="æ˜Ÿå…‰ä¸é—®èµ¶è·¯äºº">æ˜Ÿå…‰ä¸é—®èµ¶è·¯äºº</div>
        <div class="message-option" data-message="æ„¿ä½ æ‰€æ„¿çš†æˆçœŸ">æ„¿ä½ æ‰€æ„¿çš†æˆçœŸ</div>
      </div>
      <button id="submit-message-btn" class="btn-primary">ç•™ä¸‹ç•™è¨€</button>
    </div>
  </div>

  <!-- æç¤ºä¿¡æ¯ -->
  <div id="toast" class="toast"></div>

<script>
// å…¨å±€çŠ¶æ€
let userSettings = {
  nickname: '',
  color: 'white',
  symbol: 'âœ¦'
};
let selectedStarIndex = -1;
let starsData = [];

// é¢œè‰²é…ç½® - ä½¿ç”¨ CSS å˜é‡
const colorMap = {
  white: { color: '#fff9e6', var: 'var(--star-white)' },
  gold: { color: '#ffd700', var: 'var(--star-gold)' },
  blue: { color: '#87ceeb', var: 'var(--star-blue)' },
  pink: { color: '#ffb6c1', var: 'var(--star-pink)' },
  purple: { color: '#da70d6', var: 'var(--star-purple)' }
};

// åˆ¤æ–­æ˜Ÿæ˜Ÿå¹´é¾„ï¼ˆæ–°/æ—§ï¼‰
function getStarAgeClass(timestamp) {
  const now = new Date();
  const starTime = new Date(timestamp.substring(0, 4) + '-' + 
                           timestamp.substring(4, 6) + '-' + 
                           timestamp.substring(6, 8));
  const daysDiff = (now - starTime) / (1000 * 60 * 60 * 24);
  return daysDiff < 7 ? 'new-star' : daysDiff > 30 ? 'old-star' : '';
}

// åˆå§‹åŒ–
async function initStars() {
  // æ£€æŸ¥æ˜¯å¦æ˜¯é¦–æ¬¡è®¿é—®
  const hasVisited = localStorage.getItem('mystar_visited');
  if (!hasVisited) {
    showWelcomeModal();
  } else {
    // æ¢å¤ç”¨æˆ·è®¾ç½®
    const saved = localStorage.getItem('mystar_settings');
    if (saved) {
      userSettings = JSON.parse(saved);
    }
    createUserStar();
  }
  
  // åŠ è½½æ‰€æœ‰æ˜Ÿæ˜Ÿ
  await loadAllStars();
}

// æ˜¾ç¤ºæ¬¢è¿é¢æ¿
function showWelcomeModal() {
  const modal = document.getElementById('welcome-modal');
  modal.classList.remove('hidden');
  // å¼ºåˆ¶é‡ç»˜ä»¥ç¡®ä¿åŠ¨ç”»è§¦å‘
  void modal.offsetWidth;
  modal.classList.add('active');
  
  // é¢œè‰²é€‰æ‹©
  document.querySelectorAll('.color-option').forEach(opt => {
    opt.addEventListener('click', () => {
      document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
      opt.classList.add('selected');
      userSettings.color = opt.dataset.color;
    });
  });
  
  // ç¬¦å·é€‰æ‹©
  document.querySelectorAll('.symbol-option').forEach(opt => {
    opt.addEventListener('click', () => {
      document.querySelectorAll('.symbol-option').forEach(o => o.classList.remove('selected'));
      opt.classList.add('selected');
      userSettings.symbol = opt.dataset.symbol;
    });
  });
  
  // æ˜µç§°é€‰æ‹©
  document.querySelectorAll('.nickname-option').forEach(opt => {
    opt.addEventListener('click', () => {
      document.querySelectorAll('.nickname-option').forEach(o => o.classList.remove('selected'));
      opt.classList.add('selected');
      userSettings.nickname = opt.dataset.nickname;
    });
  });
  
  // å¼€å§‹æŒ‰é’®
  document.getElementById('start-btn').addEventListener('click', () => {
    const selectedNickname = document.querySelector('.nickname-option.selected');
    userSettings.nickname = selectedNickname ? selectedNickname.dataset.nickname : 'åŒ¿åæ—…äºº';
    
    localStorage.setItem('mystar_visited', 'true');
    localStorage.setItem('mystar_settings', JSON.stringify(userSettings));
    
    const modal = document.getElementById('welcome-modal');
    modal.classList.remove('active');
    setTimeout(() => {
      modal.classList.add('hidden');
      createUserStar();
    }, 400);
  });
}

// åˆ›å»ºç”¨æˆ·æ˜Ÿæ˜Ÿ
async function createUserStar() {
  try {
    const res = await fetch('/api/stars', { 
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(userSettings)
    });
    const newStar = await res.json();
    addStar(newStar, true, 0);
  } catch(e) {
    console.error('åˆ›å»ºæ˜Ÿæ˜Ÿå¤±è´¥:', e);
  }
}

// åŠ è½½æ‰€æœ‰æ˜Ÿæ˜Ÿ
async function loadAllStars() {
  try {
    const res = await fetch('/api/stars');
    starsData = await res.json();
    
    // åå‘éå†ï¼Œè®©æ–°æ˜Ÿæ˜Ÿåœ¨åé¢ï¼ˆä¸Šå±‚ï¼‰
    starsData.forEach((star, index) => {
      // è·³è¿‡åˆšåˆ›å»ºçš„é‚£ä¸ªï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if (index > 0 || !localStorage.getItem('mystar_visited')) {
        setTimeout(() => {
          addStar(star, false, index);
        }, Math.min(index * 80, 2000)); // ä¾æ¬¡å‡ºç°æ•ˆæœï¼Œæœ€å¤šå»¶è¿Ÿ2ç§’
      }
    });
  } catch(e) {
    console.error('åŠ è½½æ˜Ÿæ˜Ÿå¤±è´¥:', e);
  }
}

// æ·»åŠ æ˜Ÿæ˜Ÿåˆ°é¡µé¢
function addStar(star, animate = false, index = 0) {
  const div = document.createElement('div');
  
  // è®¡ç®—æ˜Ÿæ˜Ÿå¹´é¾„ç±»
  const ageClass = getStarAgeClass(star.time);
  div.className = 'star' + (animate ? ' animate' : ' enter-anim') + 
                  (index > 0 ? ' other-star' : '') + 
                  (ageClass ? ' ' + ageClass : '');
  
  const left = getRandomPos('left');
  const top = getRandomPos('top');
  div.style.left = left;
  div.style.top = top;
  div.style.fontSize = (0.8 + Math.random() * 1.2) + 'rem';
  
  // åº”ç”¨é¢œè‰² - ä½¿ç”¨ CSS å˜é‡
  const colorConfig = colorMap[star.color] || colorMap.white;
  div.style.color = colorConfig.color;
  
  // å­˜å‚¨ CSS å˜é‡ä¾›æ¶Ÿæ¼ªæ•ˆæœä½¿ç”¨
  div.style.setProperty('--star-color', colorConfig.color);
  
  // å­˜å‚¨æ˜Ÿæ˜Ÿç´¢å¼•
  div.dataset.index = index;
  
  const displayName = star.nickname || 'åŒ¿åæ—…äºº';
  const message = star.message ? `<div class="message">${escapeHtml(star.message)}</div>` : '';
  
  div.innerHTML = `
    <span class="star-symbol">${star.symbol || 'âœ¦'}</span>
    <span class="info">
      <strong>${escapeHtml(displayName)}</strong>
      <span class="meta">${star.time} Â· ${star.location}</span>
      ${message}
    </span>
  `;
  
  // ç‚¹å‡»äº‹ä»¶ - æ·»åŠ æ¶Ÿæ¼ªæ•ˆæœ
  div.addEventListener('click', (e) => {
    e.stopPropagation();
    div.classList.add('clicked');
    setTimeout(() => div.classList.remove('clicked'), 600);
    openMessageModal(index, star);
  });
  
  document.getElementById('stars').appendChild(div);
}

// è·å–éšæœºä½ç½®
function getRandomPos(axis) {
  const max = axis === 'left' ? 95 : 90;
  let pos = Math.random() * max;
  // é¿å…å¤ªé è¿‘è¾¹ç¼˜
  pos = Math.max(2, Math.min(pos, max - 2));
  return pos + (axis === 'left' ? 'vw' : 'vh');
}

// æ‰“å¼€ç•™è¨€å¼¹çª—
function openMessageModal(index, star) {
  selectedStarIndex = index;
  const modal = document.getElementById('message-modal');
  const infoDiv = document.getElementById('star-info');
  const messageDisplay = document.getElementById('message-display');
  const messageInput = document.getElementById('message-input');
  
  const displayName = star.nickname || 'åŒ¿åæ—…äºº';
  const colorConfig = colorMap[star.color] || colorMap.white;
  
  infoDiv.innerHTML = `
    <span class="star-symbol-large" style="color: ${colorConfig.color}; text-shadow: 0 0 20px ${colorConfig.color};">${star.symbol || 'âœ¦'}</span>
    <div class="owner-info">
      <strong>${escapeHtml(displayName)}</strong>
      <span>${star.time} Â· ${star.location}</span>
    </div>
  `;
  
  if (star.message) {
    messageDisplay.innerHTML = `<div class="existing-message">${escapeHtml(star.message)}</div>`;
  } else {
    messageDisplay.innerHTML = '<div class="no-message">è¿˜æ²¡æœ‰ç•™è¨€</div>';
  }
  
  messageInput.value = '';
  modal.classList.remove('hidden');
  // å¼ºåˆ¶é‡ç»˜ä»¥ç¡®ä¿åŠ¨ç”»è§¦å‘
  void modal.offsetWidth;
  modal.classList.add('active');
}

// å…³é—­ç•™è¨€å¼¹çª—
function closeMessageModal() {
  const modal = document.getElementById('message-modal');
  modal.classList.remove('active');
  setTimeout(() => {
    modal.classList.add('hidden');
    selectedStarIndex = -1;
  }, 400);
}

// ç•™è¨€é€‰æ‹©
let selectedMessage = '';
document.querySelectorAll('.message-option').forEach(opt => {
  opt.addEventListener('click', () => {
    document.querySelectorAll('.message-option').forEach(o => o.classList.remove('selected'));
    opt.classList.add('selected');
    selectedMessage = opt.dataset.message;
  });
});

// æäº¤ç•™è¨€
document.getElementById('submit-message-btn').addEventListener('click', async () => {
  const message = selectedMessage;
  if (!message) {
    showToast('è¯·é€‰æ‹©ä¸€å¥ç•™è¨€');
    return;
  }
  
  if (selectedStarIndex < 0) return;
  
  try {
    const res = await fetch('/api/stars', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ index: selectedStarIndex, message })
    });
    
    if (res.ok) {
      const updated = await res.json();
      starsData[selectedStarIndex] = updated;
      
      // æ›´æ–°æ˜¾ç¤º
      document.getElementById('message-display').innerHTML = 
        `<div class="existing-message">${escapeHtml(message)}</div>`;
      
      // æ›´æ–° tooltip
      updateStarTooltip(selectedStarIndex, updated);
      
      showToast('ç•™è¨€å·²ä¿å­˜ âœ¨');
      selectedMessage = '';
      document.querySelectorAll('.message-option').forEach(o => o.classList.remove('selected'));
      
      setTimeout(closeMessageModal, 800);
    }
  } catch(e) {
    showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
});

// æ›´æ–°æ˜Ÿæ˜Ÿ tooltip
function updateStarTooltip(index, star) {
  const stars = document.querySelectorAll('.star');
  if (stars[index]) {
    const displayName = star.nickname || 'åŒ¿åæ—…äºº';
    const message = star.message ? `<div class="message">${escapeHtml(star.message)}</div>` : '';
    const info = stars[index].querySelector('.info');
    if (info) {
      info.innerHTML = `
        <strong>${escapeHtml(displayName)}</strong>
        <span class="meta">${star.time} Â· ${star.location}</span>
        ${message}
      `;
    }
  }
}

// HTML è½¬ä¹‰
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// æ˜¾ç¤ºæç¤º
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

// ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¼¹çª—
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('modal') && e.target.id === 'message-modal') {
    closeMessageModal();
  }
});
</script>
</body>
</html>
